#!/usr/bin/env bash
set -e
set -o pipefail

script_dir="$(dirname $0)"

function docker_compose() {
    project="$1"
    stage="$2"
    [[ -n "$stage" ]] && add_args="-f $project/docker-compose.$stage.yml" || add_args=""
    docker-compose -p "$stage$project" -f $project/docker-compose.yml $add_args ${@:3}
}
function postgres_command() {
    docker exec -it "devcore_postgres_1" "$@"
}
override_sbt_args="${@:2}" # all remaining arguments starting at 2
function sbt_with_args() {
    args="${@:1}"
    [ -n "$override_sbt_args" ] && args="$override_sbt_args"

    sbt -Dquill.macro.log=false $args
}

DOCKERHOST_IP=`ip -4 addr show scope global dev docker0 | grep inet | awk '{print \$2}' | cut -d / -f 1`

env_wust_secret="WUST_AUTH_SECRET=secret WUST_USER=wust WUST_PASSWORD=wust"
env_wust_local="WUST_HOSTNAME=localhost DEV_DOCKERHOST_IP=$DOCKERHOST_IP"
env_postgres_secret="POSTGRES_PASSWORD=test"
env_postgres_local="POSTGRES_HOSTNAME=localhost POSTGRES_USER=wust POSTGRES_DB=wust POSTGRES_PORT_CORE=5433"
env_redis_local="REDIS_HOSTNAME=localhost REDIS_PORT_GITHUB=6380"

env_wust_local_connectivity="WUST_PORT=${WUST_PORT:-12345} WUST_CORE_PORT=${WUST_CORE_PORT:-9000} WUST_WEB_PORT=${WUST_WEB_PORT:-9001} WUST_GITHUB_PORT=${WUST_GITHUB_PORT:-9002} DEV_SERVER_COMPRESS=${DEV_SERVER_COMPRESS:-false}"

if [[ -f tokens.sh ]]; then
    source tokens.sh
fi

function self() {
    case "$1" in
    psql)
        # PGPASSWORD=test psql -h localhost -U wust
        postgres_command psql -h localhost -U wust ${@:2}
        ;;
    pgdump)
        postgres_command pg_dump --clean -h localhost -U wust > $(date +"%F-%H-%M-%S-dev-postgres-backup.sql")
        ;;
    pgrestore)
        postgres_command psql --single-transaction --set ON_ERROR_STOP=on -h localhost -U wust --file=- < $2
        ;;
    pgclean)
        postgres_command psql -h localhost -U wust -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;"
        ;;
    sbt)
        env="$env_postgres_secret $env_wust_secret $env_postgres_local $env_redis_local $env_wust_local $env_wust_local_connectivity"
        echo -e "- ENV: \e[1m\e[32m$env\e[0m"
        export $env

        case "$2" in
        core)
            docker_compose core dev up -d db-migration
            ;;
        githubApp)
            docker_compose githubApp dev up -d redis
            ;;
        gitterApp)
            ;;
        slackApp)
            ;;
        *)
            docker_compose core dev up -d db-migration
            docker_compose githubApp dev up -d redis
            ;;
        esac

        sbt
        ;;
    apps)
        env="$env_postgres_secret $env_wust_secret $env_postgres_local $env_redis_local $env_wust_local $env_wust_local_connectivity"
        echo -e "- ENV: \e[1m\e[32m$env\e[0m"
        export $env
        if [[ -z "$2" ]]; then
            docker_compose githubApp dev up -d
            docker_compose webApp dev up -d
        else
            docker_compose "$2" dev up -d
        fi
        ;;
    env)
        echo "export $env_postgres_secret $env_wust_secret $env_postgres_local $env_redis_local $env_wust_local $env_wust_local_connectivity"
        ;;
    migrate)
        export $env_postgres_secret $env_wust_local_connectivity
        sbt dbMigration/docker
        docker_compose core dev run db-migration
        ;;
    test)
        sbt docker
        sbt_with_args test
        self test.postgres
        self test.integration
        ;;
    test.postgres)
        export $env_wust_local_connectivity
        docker_compose core test.postgres run db-migration
        docker_compose core test.postgres run test-postgres
        docker_compose core test.postgres down -v
        ;;
    test.integration)
        export $env_postgres_secret $env_wust_secret $env_postgres_local $env_redis_local $env_wust_local_connectivity
        docker_compose core dev up -d
        docker_compose webApp dev up -d
        docker_compose core dev run db-migration
        postgres_command psql -U postgres --command="DROP DATABASE IF EXISTS wust_template"
        postgres_command psql -U postgres --command="CREATE DATABASE wust_template TEMPLATE wust"
        sbt_with_args coverage it:test coverageReport
        docker_compose core dev down -v
        ;;
    *)
        cat <<EOF
    unknown option '$1', expected one of:

    sbt
    apps
    env
    migrate

    psql [options]
    pgdump
    pgrestore file
    pgclean

    test
    test.postgres
    test.integration
EOF
        exit 1

    esac
}

self $@
